<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketè°ƒè¯•æµ‹è¯•</title>
</head>
<body>
    <h1>WebSocketæ¶ˆæ¯æ ¼å¼è°ƒè¯•</h1>
    <div>
        <button id="connectBtn">è¿æ¥è°ƒè¯•æœåŠ¡å™¨</button>
        <button id="sendTimestampBtn" disabled>å‘é€æ—¶é—´æˆ³æ¶ˆæ¯</button>
        <button id="sendAudioBtn" disabled>å‘é€éŸ³é¢‘æ•°æ®</button>
        <button id="disconnectBtn" disabled>æ–­å¼€è¿æ¥</button>
    </div>
    <div>
        <h3>æ—¥å¿—:</h3>
        <div id="log" style="height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; font-family: monospace;"></div>
    </div>

    <script>
        let socket = null;
        const log = document.getElementById('log');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }
        
        // åˆ›å»ºæµ‹è¯•éŸ³é¢‘æ•°æ®ï¼ˆç®€å•çš„WAVæ–‡ä»¶ï¼‰
        function createTestWAVData() {
            const sampleRate = 16000;
            const duration = 3; // 3ç§’
            const numSamples = sampleRate * duration;
            
            // WAVæ–‡ä»¶å¤´
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            
            // RIFF header
            view.setUint32(0, 0x46464952, false); // "RIFF"
            view.setUint32(4, 36 + numSamples * 2, true); // file size
            view.setUint32(8, 0x45564157, false); // "WAVE"
            
            // fmt chunk
            view.setUint32(12, 0x20746d66, false); // "fmt "
            view.setUint32(16, 16, true); // chunk size
            view.setUint16(20, 1, true); // audio format (PCM)
            view.setUint16(22, 1, true); // num channels
            view.setUint32(24, sampleRate, true); // sample rate
            view.setUint32(28, sampleRate * 2, true); // byte rate
            view.setUint16(32, 2, true); // block align
            view.setUint16(34, 16, true); // bits per sample
            
            // data chunk
            view.setUint32(36, 0x61746164, false); // "data"
            view.setUint32(40, numSamples * 2, true); // data size
            
            // åˆ›å»ºéŸ³é¢‘æ•°æ®ï¼ˆé™éŸ³ï¼‰
            const audioData = new ArrayBuffer(numSamples * 2);
            const audioView = new Int16Array(audioData);
            for (let i = 0; i < numSamples; i++) {
                audioView[i] = 0; // é™éŸ³
            }
            
            // åˆå¹¶å¤´éƒ¨å’Œæ•°æ®
            const wavData = new Uint8Array(header.byteLength + audioData.byteLength);
            wavData.set(new Uint8Array(header), 0);
            wavData.set(new Uint8Array(audioData), header.byteLength);
            
            return wavData.buffer;
        }
        
        document.getElementById('connectBtn').onclick = function() {
            if (socket) {
                addLog('å·²ç»è¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }
            
            addLog('æ­£åœ¨è¿æ¥åˆ°è°ƒè¯•æœåŠ¡å™¨...');
            socket = new WebSocket('ws://localhost:8001/ws/debug');
            
            socket.onopen = function() {
                addLog('âœ… WebSocketè¿æ¥å·²å»ºç«‹');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('sendTimestampBtn').disabled = false;
                document.getElementById('sendAudioBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = false;
            };
            
            socket.onmessage = function(event) {
                addLog(`ğŸ“¨ æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯: ${event.data}`);
            };
            
            socket.onclose = function() {
                addLog('âŒ WebSocketè¿æ¥å·²å…³é—­');
                socket = null;
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('sendTimestampBtn').disabled = true;
                document.getElementById('sendAudioBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = true;
            };
            
            socket.onerror = function(error) {
                addLog(`âŒ WebSocketé”™è¯¯: ${error}`);
            };
        };
        
        document.getElementById('sendTimestampBtn').onclick = function() {
            if (!socket) {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }
            
            const timestampMessage = {
                type: 'audio_with_timestamp',
                timestamp: {
                    start_time: 6.0,
                    end_time: 9.0,
                    duration: 3.0,
                    chunk_index: 2,
                    total_samples_processed: 48000,
                    audio_start_time: performance.now(),
                    processing_start_time: performance.now(),
                    current_time: performance.now()
                }
            };
            
            addLog('ğŸ“¤ å‘é€æ—¶é—´æˆ³æ¶ˆæ¯...');
            socket.send(JSON.stringify(timestampMessage));
        };
        
        document.getElementById('sendAudioBtn').onclick = function() {
            if (!socket) {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }
            
            const wavData = createTestWAVData();
            addLog(`ğŸ“¤ å‘é€éŸ³é¢‘æ•°æ®ï¼Œå¤§å°: ${wavData.byteLength} bytes`);
            socket.send(wavData);
        };
        
        document.getElementById('disconnectBtn').onclick = function() {
            if (socket) {
                socket.close();
            }
        };
    </script>
</body>
</html>
